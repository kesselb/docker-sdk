{% extends "nginx/http/application.server.conf.twig" %}

{% block map %}

{% if endpointData['cors-allow-origin'] is not empty %}
# is allowed origin
map $http_origin $allow_origin_zed {
    ~^{{ endpointData['cors-allow-origin'] | default('') | nginx_var }}$ $http_origin;
}
{% endif %}

{% endblock %}

{% block server %}
{{ parent() }}

{% include "nginx/vhost.d/zed.default.conf.twig" with _context %}
{% include "nginx/vhost.d/timeouts.conf.twig" with { timeout: timeout | default('1m') } %}
{% endblock server %}
{% block location %}
{{ parent() }}

        fastcgi_param SPRYKER_ZED_HOST "zed.calls.are.forbidden.from.zed";
        fastcgi_param SPRYKER_ZED_PORT "{{ project['_defaultPort'] }}";

        fastcgi_param SPRYKER_SESSION_BE_NAMESPACE "{{ storeServices['session']['namespace'] | default(endpointData['services']['session']['namespace']) }}";
        fastcgi_param SPRYKER_BE_HOST "{{ host }}";
        fastcgi_param SPRYKER_BE_PORT "{{ externalPort }}";

{% if endpointData['cors-allow-origin'] is not empty %}
        fastcgi_param SPRYKER_GLUE_APPLICATION_CORS_ALLOW_ORIGIN "{{ endpointData['cors-allow-origin'] | default('') | nginx_var }}";
{% endif %}
{% if storeServices['mail']['sender']['email'] is not empty %}
        fastcgi_param SPRYKER_MAIL_SENDER_EMAIL "{{ storeServices['mail']['sender']['email'] }}";
{% endif %}
{% if storeServices['mail']['sender']['name'] is not empty %}
        fastcgi_param SPRYKER_MAIL_SENDER_NAME "{{ storeServices['mail']['sender']['name'] }}";
{% endif %}

{% if project['_endpointMap'][endpointData['store']]['yves'] is not empty %}
        fastcgi_param SPRYKER_FE_HOST "{{ project['_endpointMap'][endpointData['store']]['yves'] }}";
        fastcgi_param SPRYKER_FE_PORT "{{ (project['_endpointMap'][endpointData['store']]['yves'] | split(':'))[1] | default(project['_defaultPort']) }}";
{% endif %}

{% if project['_endpointMap'][endpointData['store']]['glue'] is not empty %}
        fastcgi_param SPRYKER_API_HOST "{{ project['_endpointMap'][endpointData['store']]['glue'] }}";
        fastcgi_param SPRYKER_API_PORT "{{ (project['_endpointMap'][endpointData['store']]['glue'] | split(':'))[1] | default(project['_defaultPort']) }}";
{% endif %}

{% if endpointData['cors-allow-origin'] is not empty %}
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '$allow_origin_zed' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' '{{ endpointData['cors-allow-headers'] | default('') | nginx_var }}' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Expose-Headers' 'ETag' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Content-Type' 'text/plain; charset=utf-8' always;
            add_header 'Content-Length' 0 always;

            return 204;
        }
{% endif %}

{% endblock location %}
